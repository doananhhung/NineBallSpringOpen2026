<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Nine Ball Spring Open 2026</title>

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Styles -->
    <?!= include('styles'); ?>
</head>

<body>
    <div class="container">
        <!-- Admin Warning -->
        <div class="admin-header">
            <span class="admin-header__icon">üîê</span>
            <span class="admin-header__text">Admin Panel - Ch·ªâ d√†nh cho qu·∫£n l√Ω gi·∫£i ƒë·∫•u</span>
        </div>

        <!-- Header -->
        <header class="header" style="padding: 1rem 0;">
            <h1 class="header__title" style="font-size: 1.75rem;">üé± Admin Panel</h1>
            <div class="header__subtitle">
                <span class="header__badge" id="roundBadge">V√≤ng 0/0</span>
                <span id="statusBadge" class="status-badge status-badge--registration">ƒêang t·∫£i...</span>
            </div>
        </header>

        <!-- Alert Container -->
        <div id="alertContainer"></div>

        <!-- Main Content -->
        <main>
            <div class="grid grid--2">
                <!-- Left Column: Tournament Config & Players -->
                <div>
                    <!-- Tournament Config -->
                    <section class="card">
                        <div class="card__header">
                            <span class="card__icon">‚öôÔ∏è</span>
                            <h2 class="card__title">C·∫•u H√¨nh Gi·∫£i ƒê·∫•u</h2>
                        </div>

                        <div class="form-group">
                            <label class="form-label">T√™n gi·∫£i ƒë·∫•u</label>
                            <input type="text" class="form-input" id="tournamentName"
                                placeholder="Nine Ball Spring Open 2026">
                        </div>

                        <div class="form-group">
                            <label class="form-label">S·ªë v√≤ng ƒë·∫•u</label>
                            <input type="number" class="form-input" id="totalRounds" min="1" max="10" value="5">
                        </div>

                        <button class="btn btn--primary" onclick="saveConfig()" id="saveConfigBtn">
                            üíæ L∆∞u c·∫•u h√¨nh
                        </button>
                    </section>

                    <!-- Player Management -->
                    <section class="card">
                        <div class="card__header">
                            <span class="card__icon">üë•</span>
                            <h2 class="card__title">Qu·∫£n L√Ω Ng∆∞·ªùi Ch∆°i</h2>
                            <span style="margin-left: auto; color: var(--text-muted);" id="playerCount">0/32</span>
                        </div>

                        <!-- Add Player Form -->
                        <div class="form-row" id="addPlayerForm">
                            <div class="form-group" style="flex: 2;">
                                <label class="form-label">T√™n ng∆∞·ªùi ch∆°i</label>
                                <input type="text" class="form-input" id="playerName" placeholder="Nguy·ªÖn VƒÉn A">
                            </div>
                            <div class="form-group" style="flex: 1;">
                                <label class="form-label">H·∫°ng</label>
                                <select class="form-select" id="playerRank">
                                    <option value="G">G</option>
                                    <option value="H">H</option>
                                    <option value="I">I</option>
                                </select>
                            </div>
                            <div class="form-group" style="flex: 0;">
                                <label class="form-label">&nbsp;</label>
                                <button class="btn btn--success" onclick="addPlayer()">+ Th√™m</button>
                            </div>
                        </div>

                        <!-- Player List -->
                        <div id="playerList" style="margin-top: 1rem; max-height: 300px; overflow-y: auto;">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </section>
                </div>

                <!-- Right Column: Match Management -->
                <div>
                    <!-- Match Control -->
                    <section class="card">
                        <div class="card__header">
                            <span class="card__icon">üéÆ</span>
                            <h2 class="card__title">ƒêi·ªÅu Khi·ªÉn Gi·∫£i ƒê·∫•u</h2>
                        </div>

                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button class="btn btn--primary" onclick="generatePairings()" id="generateBtn">
                                üé≤ T·∫°o c·∫∑p ƒë·∫•u v√≤ng m·ªõi
                            </button>
                            <button class="btn btn--secondary" onclick="window.open('?key=admin123', '_blank')">
                                üëÅÔ∏è Xem trang c√¥ng khai
                            </button>
                        </div>

                        <hr style="border: none; border-top: 1px solid var(--glass-border); margin: 1rem 0;">

                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn--danger btn--sm" onclick="confirmResetTournament()">
                                üîÑ Reset k·∫øt qu·∫£
                            </button>
                            <button class="btn btn--danger btn--sm" onclick="confirmResetAll()">
                                ‚ö†Ô∏è Xo√° t·∫•t c·∫£
                            </button>
                        </div>
                    </section>

                    <!-- Score Input -->
                    <section class="card">
                        <div class="card__header">
                            <span class="card__icon">üìù</span>
                            <h2 class="card__title">Nh·∫≠p T·ªâ S·ªë</h2>
                            <span style="margin-left: auto; color: var(--text-muted);" id="matchProgress">0/0</span>
                        </div>

                        <div id="scoreInputContainer">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Completed Matches (Editable) -->
                    <section class="card">
                        <div class="card__header">
                            <span class="card__icon">‚úÖ</span>
                            <h2 class="card__title">Tr·∫≠n ƒê√£ Ho√†n Th√†nh</h2>
                            <span style="margin-left: auto; color: var(--text-muted);">Nh·∫•n ‚úèÔ∏è ƒë·ªÉ s·ª≠a</span>
                        </div>

                        <div id="completedMatchesContainer" style="max-height: 300px; overflow-y: auto;">
                            <div class="loading">
                                <div class="spinner"></div>
                            </div>
                        </div>
                    </section>

                    <!-- Quick Leaderboard -->
                    <section class="card">
                        <div class="card__header">
                            <span class="card__icon">üìä</span>
                            <h2 class="card__title">B·∫£ng X·∫øp H·∫°ng</h2>
                        </div>

                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>T√™n</th>
                                        <th>W-L</th>
                                        <th>+/-</th>
                                    </tr>
                                </thead>
                                <tbody id="leaderboardBody">
                                    <tr>
                                        <td colspan="4" style="text-align: center;">ƒêang t·∫£i...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script>
        // ============ State ============
        let tournamentConfig = null;
        let players = [];
        let allMatches = [];

        // ============ API Helpers ============
        function callApi(functionName, ...args) {
            return new Promise((resolve, reject) => {
                google.script.run
                    .withSuccessHandler(resolve)
                    .withFailureHandler(reject)
                [functionName](...args);
            });
        }

        // ============ Alert System ============
        function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert--${type}`;
            alert.innerHTML = `<span>${message}</span>`;
            container.appendChild(alert);

            setTimeout(() => alert.remove(), 5000);
        }

        // ============ Data Loading ============
        async function loadAllData() {
            try {
                const [config, playerList, matches, leaderboard] = await Promise.all([
                    callApi('api_getTournamentConfig'),
                    callApi('api_getPlayers'),
                    callApi('api_getAllMatches'),
                    callApi('api_getLeaderboard')
                ]);

                tournamentConfig = config;
                players = playerList;
                allMatches = matches;

                renderAll(leaderboard);
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
            }
        }

        // ============ Render Functions ============
        function renderAll(leaderboard) {
            renderStatus();
            renderConfig();
            renderPlayers();
            renderScoreInput();
            renderCompletedMatches();
            renderLeaderboard(leaderboard);
            updateButtonStates();
        }

        function renderStatus() {
            document.getElementById('roundBadge').textContent =
                `V√≤ng ${tournamentConfig.currentRound}/${tournamentConfig.totalRounds}`;

            const statusBadge = document.getElementById('statusBadge');
            const statusMap = {
                'registration': { text: 'üìù ƒêƒÉng k√Ω', class: 'status-badge--registration' },
                'ongoing': { text: 'üé± ƒêang di·ªÖn ra', class: 'status-badge--ongoing' },
                'finished': { text: 'üèÜ ƒê√£ k·∫øt th√∫c', class: 'status-badge--finished' }
            };
            const status = statusMap[tournamentConfig.status];
            statusBadge.textContent = status.text;
            statusBadge.className = 'status-badge ' + status.class;
        }

        function renderConfig() {
            document.getElementById('tournamentName').value = tournamentConfig.tournamentName;
            document.getElementById('totalRounds').value = tournamentConfig.totalRounds;
        }

        function renderPlayers() {
            const container = document.getElementById('playerList');
            const countEl = document.getElementById('playerCount');

            countEl.textContent = `${players.length}/32`;

            if (players.length === 0) {
                container.innerHTML = `
          <div class="empty-state">
            <p>Ch∆∞a c√≥ ng∆∞·ªùi ch∆°i. Th√™m ng∆∞·ªùi ch∆°i ƒë·ªÉ b·∫Øt ƒë·∫ßu!</p>
          </div>
        `;
                return;
            }

            const canRemove = tournamentConfig.status === 'registration';

            container.innerHTML = players.map((player, index) => `
        <div class="player-item">
          <div class="player-item__info">
            <span class="player-item__number">${index + 1}</span>
            <span><strong>${escapeHtml(player.name)}</strong></span>
            <span class="player-rank-badge">${escapeHtml(player.rank)}</span>
          </div>
          ${canRemove ? `
            <button class="btn btn--danger btn--sm" onclick="removePlayer('${player.id}')">‚úï</button>
          ` : ''}
        </div>
      `).join('');
        }

        function renderScoreInput() {
            const container = document.getElementById('scoreInputContainer');
            const progressEl = document.getElementById('matchProgress');

            const currentMatches = allMatches.filter(m => m.round === tournamentConfig.currentRound);
            const pendingMatches = currentMatches.filter(m => m.status === 'pending' && !m.isBye);
            const completedCount = currentMatches.filter(m => m.status === 'completed').length;

            progressEl.textContent = `${completedCount}/${currentMatches.length}`;

            if (pendingMatches.length === 0) {
                const message = tournamentConfig.currentRound === 0
                    ? 'Nh·∫•n "T·∫°o c·∫∑p ƒë·∫•u v√≤ng m·ªõi" ƒë·ªÉ b·∫Øt ƒë·∫ßu'
                    : 'T·∫•t c·∫£ tr·∫≠n ƒë·∫•u ƒë√£ ho√†n th√†nh!';
                container.innerHTML = `
          <div class="empty-state">
            <p>${message}</p>
          </div>
        `;
                return;
            }

            container.innerHTML = pendingMatches.map(match => `
        <div class="match-card" data-match-id="${match.id}">
          <div class="match-player">
            <div class="match-player__name">${escapeHtml(match.player1Name)}</div>
          </div>
          <div class="match-vs">
            <div class="score-input-group">
              <input type="number" class="form-input score-input" 
                     id="score1_${match.id}" min="0" max="99" placeholder="0">
              <span>:</span>
              <input type="number" class="form-input score-input" 
                     id="score2_${match.id}" min="0" max="99" placeholder="0">
            </div>
          </div>
          <div class="match-player">
            <div class="match-player__name">${escapeHtml(match.player2Name)}</div>
          </div>
          <button class="btn btn--success btn--sm" onclick="submitScore('${match.id}')">‚úì</button>
        </div>
      `).join('');
        }

        function renderCompletedMatches() {
            const container = document.getElementById('completedMatchesContainer');

            const currentMatches = allMatches.filter(m => m.round === tournamentConfig.currentRound);
            const completedMatches = currentMatches.filter(m => m.status === 'completed');

            if (completedMatches.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>Ch∆∞a c√≥ tr·∫≠n ƒë·∫•u n√†o ho√†n th√†nh</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = completedMatches.map(match => {
                const isEditing = match.isEditing;
                const isBye = match.isBye;
                const winnerClass1 = match.winner === match.player1Id ? 'stat-positive' : '';
                const winnerClass2 = match.winner === match.player2Id ? 'stat-positive' : '';

                if (isBye) {
                    return `
                        <div class="match-card match-card--completed" style="opacity: 0.7;">
                            <div class="match-player">
                                <div class="match-player__name">${escapeHtml(match.player1Name)}</div>
                            </div>
                            <div class="match-vs">
                                <span class="stat-positive" style="font-weight: bold;">BYE</span>
                            </div>
                            <div class="match-player">
                                <div class="match-player__name" style="color: var(--text-muted);">‚Äî</div>
                            </div>
                        </div>
                    `;
                }

                return `
                    <div class="match-card match-card--completed" data-match-id="${match.id}">
                        <div class="match-player">
                            <div class="match-player__name ${winnerClass1}">${escapeHtml(match.player1Name)}</div>
                        </div>
                        <div class="match-vs">
                            <div class="score-display" id="display_${match.id}">
                                <span class="${winnerClass1}" style="font-weight: bold; font-size: 1.2rem;">${match.score1}</span>
                                <span style="margin: 0 0.3rem;">:</span>
                                <span class="${winnerClass2}" style="font-weight: bold; font-size: 1.2rem;">${match.score2}</span>
                            </div>
                            <div class="score-edit-group" id="edit_${match.id}" style="display: none;">
                                <input type="number" class="form-input score-input" 
                                       id="edit_score1_${match.id}" min="0" max="99" value="${match.score1}">
                                <span>:</span>
                                <input type="number" class="form-input score-input" 
                                       id="edit_score2_${match.id}" min="0" max="99" value="${match.score2}">
                            </div>
                        </div>
                        <div class="match-player">
                            <div class="match-player__name ${winnerClass2}">${escapeHtml(match.player2Name)}</div>
                        </div>
                        <button class="btn btn--secondary btn--sm" id="editBtn_${match.id}" onclick="toggleEditMatch('${match.id}')">‚úèÔ∏è</button>
                        <button class="btn btn--success btn--sm" id="saveBtn_${match.id}" style="display: none;" onclick="saveEditMatch('${match.id}')">‚úì</button>
                        <button class="btn btn--danger btn--sm" id="cancelBtn_${match.id}" style="display: none;" onclick="cancelEditMatch('${match.id}')">‚úï</button>
                    </div>
                `;
            }).join('');
        }

        function renderLeaderboard(leaderboard) {
            const tbody = document.getElementById('leaderboardBody');

            if (!leaderboard || leaderboard.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center;">Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>';
                return;
            }

            tbody.innerHTML = leaderboard.slice(0, 10).map(player => {
                const diffClass = player.rackDiff > 0 ? 'stat-positive' : (player.rackDiff < 0 ? 'stat-negative' : '');
                const diffSign = player.rackDiff > 0 ? '+' : '';
                return `
          <tr>
            <td>${player.rank}</td>
            <td>${escapeHtml(player.name)}</td>
            <td>${player.wins}-${player.losses}</td>
            <td class="${diffClass}">${diffSign}${player.rackDiff}</td>
          </tr>
        `;
            }).join('');
        }

        function updateButtonStates() {
            const addForm = document.getElementById('addPlayerForm');
            const generateBtn = document.getElementById('generateBtn');
            const saveConfigBtn = document.getElementById('saveConfigBtn');

            const isRegistration = tournamentConfig.status === 'registration';
            const isFinished = tournamentConfig.status === 'finished';
            const currentMatches = allMatches.filter(m => m.round === tournamentConfig.currentRound);
            const allCompleted = currentMatches.every(m => m.status === 'completed');
            const canGenerate = (isRegistration && players.length >= 2) ||
                (!isFinished && allCompleted && tournamentConfig.currentRound < tournamentConfig.totalRounds);

            // Disable add player if tournament started
            if (!isRegistration) {
                addForm.style.opacity = '0.5';
                addForm.querySelectorAll('input, select, button').forEach(el => el.disabled = true);
            }

            // Generate button text
            if (tournamentConfig.currentRound === 0) {
                generateBtn.innerHTML = 'üé≤ B·∫Øt ƒë·∫ßu v√≤ng 1';
            } else if (tournamentConfig.currentRound >= tournamentConfig.totalRounds) {
                generateBtn.innerHTML = 'üèÜ Gi·∫£i ƒë·∫•u k·∫øt th√∫c';
                generateBtn.disabled = true;
            } else {
                generateBtn.innerHTML = `üé≤ T·∫°o c·∫∑p ƒë·∫•u v√≤ng ${tournamentConfig.currentRound + 1}`;
            }

            generateBtn.disabled = !canGenerate || isFinished;

            // Cho ph√©p ch·ªânh s·ª≠a s·ªë v√≤ng khi ƒëang di·ªÖn ra (ƒë·ªÉ tƒÉng s·ªë v√≤ng)
            // Ch·ªâ disable khi gi·∫£i ƒë√£ k·∫øt th√∫c ho√†n to√†n
            saveConfigBtn.disabled = false;

            // Set min c·ªßa input s·ªë v√≤ng = v√≤ng hi·ªán t·∫°i (kh√¥ng cho gi·∫£m)
            document.getElementById('totalRounds').min = Math.max(1, tournamentConfig.currentRound);

            // Disable t√™n gi·∫£i ƒë·∫•u khi ƒë√£ b·∫Øt ƒë·∫ßu
            document.getElementById('tournamentName').disabled = !isRegistration;
        }

        // ============ Actions ============
        async function saveConfig() {
            const name = document.getElementById('tournamentName').value.trim();
            const rounds = parseInt(document.getElementById('totalRounds').value);

            if (!name) {
                showAlert('Vui l√≤ng nh·∫≠p t√™n gi·∫£i ƒë·∫•u', 'error');
                return;
            }

            if (rounds < 1 || rounds > 10) {
                showAlert('S·ªë v√≤ng ph·∫£i t·ª´ 1-10', 'error');
                return;
            }

            try {
                await callApi('api_setTournamentConfig', {
                    ...tournamentConfig,
                    tournamentName: name,
                    totalRounds: rounds
                });
                showAlert('ƒê√£ l∆∞u c·∫•u h√¨nh!', 'success');
                loadAllData();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }

        async function addPlayer() {
            const name = document.getElementById('playerName').value.trim();
            const rank = document.getElementById('playerRank').value;

            if (!name) {
                showAlert('Vui l√≤ng nh·∫≠p t√™n ng∆∞·ªùi ch∆°i', 'error');
                return;
            }

            try {
                await callApi('api_addPlayer', name, rank);
                document.getElementById('playerName').value = '';
                showAlert(`ƒê√£ th√™m: ${name}`, 'success');
                loadAllData();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }

        async function removePlayer(playerId) {
            if (!confirm('X√°c nh·∫≠n xo√° ng∆∞·ªùi ch∆°i n√†y?')) return;

            try {
                await callApi('api_removePlayer', playerId);
                showAlert('ƒê√£ xo√° ng∆∞·ªùi ch∆°i', 'success');
                loadAllData();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }

        async function generatePairings() {
            try {
                const matches = await callApi('api_generatePairings');
                showAlert(`ƒê√£ t·∫°o ${matches.length} c·∫∑p ƒë·∫•u cho v√≤ng m·ªõi!`, 'success');
                loadAllData();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }

        async function submitScore(matchId) {
            const score1 = document.getElementById(`score1_${matchId}`).value;
            const score2 = document.getElementById(`score2_${matchId}`).value;

            if (score1 === '' || score2 === '') {
                showAlert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t·ªâ s·ªë', 'error');
                return;
            }

            try {
                await callApi('api_updateMatchScore', matchId, score1, score2);
                showAlert('ƒê√£ c·∫≠p nh·∫≠t t·ªâ s·ªë!', 'success');
                loadAllData();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }

        // ============ Edit Match Score Functions ============
        function toggleEditMatch(matchId) {
            document.getElementById(`display_${matchId}`).style.display = 'none';
            document.getElementById(`edit_${matchId}`).style.display = 'flex';
            document.getElementById(`editBtn_${matchId}`).style.display = 'none';
            document.getElementById(`saveBtn_${matchId}`).style.display = 'inline-flex';
            document.getElementById(`cancelBtn_${matchId}`).style.display = 'inline-flex';
        }

        function cancelEditMatch(matchId) {
            loadAllData(); // Reload to reset the form
        }

        async function saveEditMatch(matchId) {
            const score1 = document.getElementById(`edit_score1_${matchId}`).value;
            const score2 = document.getElementById(`edit_score2_${matchId}`).value;

            if (score1 === '' || score2 === '') {
                showAlert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß t·ªâ s·ªë', 'error');
                return;
            }

            try {
                await callApi('api_correctMatchScore', matchId, score1, score2);
                showAlert('ƒê√£ s·ª≠a t·ªâ s·ªë th√†nh c√¥ng!', 'success');
                loadAllData();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }

        async function confirmResetTournament() {
            if (!confirm('‚ö†Ô∏è X√°c nh·∫≠n RESET k·∫øt qu·∫£?\n\nƒêi·ªÅu n√†y s·∫Ω:\n- Xo√° t·∫•t c·∫£ tr·∫≠n ƒë·∫•u\n- Reset ƒëi·ªÉm s·ªë v·ªÅ 0\n- Gi·ªØ l·∫°i danh s√°ch ng∆∞·ªùi ch∆°i')) {
                return;
            }

            try {
                await callApi('api_resetTournament');
                showAlert('ƒê√£ reset gi·∫£i ƒë·∫•u!', 'success');
                loadAllData();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }

        async function confirmResetAll() {
            if (!confirm('‚ö†Ô∏è XO√Å T·∫§T C·∫¢ D·ªÆ LI·ªÜU?\n\nƒêi·ªÅu n√†y s·∫Ω:\n- Xo√° t·∫•t c·∫£ ng∆∞·ªùi ch∆°i\n- Xo√° t·∫•t c·∫£ tr·∫≠n ƒë·∫•u\n- Reset to√†n b·ªô h·ªá th·ªëng\n\n‚õî KH√îNG TH·ªÇ HO√ÄN T√ÅC!')) {
                return;
            }

            if (!confirm('X√°c nh·∫≠n l·∫ßn cu·ªëi - XO√Å T·∫§T C·∫¢?')) {
                return;
            }

            try {
                await callApi('api_resetAll');
                showAlert('ƒê√£ xo√° t·∫•t c·∫£ d·ªØ li·ªáu!', 'success');
                loadAllData();
            } catch (error) {
                showAlert('L·ªói: ' + error.message, 'error');
            }
        }

        // ============ Utilities ============
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // ============ Init ============
        document.addEventListener('DOMContentLoaded', loadAllData);

        // Enter key to add player
        document.getElementById('playerName').addEventListener('keyup', (e) => {
            if (e.key === 'Enter') addPlayer();
        });
    </script>
</body>

</html>